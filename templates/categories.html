{% extends "base.html" %}

{% block title %}Gerenciar Categorias - Meu Patrimônio{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Gerenciar Categorias</h1>
        <button onclick="openModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
            <i class="fas fa-plus mr-2"></i>
            Nova Categoria
        </button>
    </div>
</div>

<!-- Categories Table -->
<div class="bg-white rounded-lg shadow-lg overflow-hidden card-shadow">
    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-4">
                <h2 class="text-xl font-semibold text-gray-900">Categorias de Ativos</h2>
                <div id="totalCount" class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded-full">
                    <!-- Total count will be shown here -->
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="clearAllFilters()" class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    <i class="fas fa-times mr-1"></i>
                    Limpar Filtros
                </button>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
            <!-- Busca Geral -->
            <div class="col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
                <input type="text" id="searchInput" placeholder="Ticker ou categoria..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <!-- Filtro por Localização -->
            <div class="col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Localização</label>
                <select id="locationFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todas</option>
                    <option value="BR">Brasil</option>
                    <option value="EXT">Exterior</option>
                </select>
            </div>
            
            <!-- Filtro por Macro Categoria -->
            <div class="col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Macro Categoria</label>
                <select id="macroCategoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todas</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <!-- Filtro por Categoria L1 -->
            <div class="col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Categoria L1</label>
                <select id="categoryL1Filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todas</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <!-- Filtro por Meta Categoria -->
            <div class="col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Meta Categoria</label>
                <select id="metaCategoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todas</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
        </div>
    </div>
    <div class="responsive-table">
        <div class="overflow-x-auto">
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr class="mt-4 sm:mt-6">
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticker</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localização</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Macro Categoria</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria L1</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria L2</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meta Categoria</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                </tr>
            </thead>
            <tbody id="categoriesTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Categories data will be populated here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="mt-6 flex justify-between items-center">
    <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-700">
            Mostrando <span id="pageInfo">1-10 de 100</span> categorias
        </div>
        <div id="filterStatus" class="text-sm text-blue-600 hidden">
            <!-- Filter status will be shown here -->
        </div>
    </div>
    <div class="flex space-x-2">
        <button onclick="previousPage()" id="prevButton" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button onclick="nextPage()" id="nextButton" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<!-- Modal for Add/Edit Category -->
<div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">Nova Categoria</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="categoryForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ticker</label>
                <input type="text" id="ticker" name="ticker" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Localização</label>
                <select id="location" name="location" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="BR">Brasil</option>
                    <option value="EXT">Exterior</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Macro Categoria
                    <span class="text-xs text-gray-500 font-normal">(Selecione uma existente ou digite uma nova)</span>
                </label>
                <div class="space-y-2">
                    <select id="macroCategorySelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="">💡 Selecione uma categoria existente</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <input type="text" id="macroCategory" name="macro_category" placeholder="✏️  Ou digite uma nova categoria" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Categoria L1
                    <span class="text-xs text-gray-500 font-normal">(Selecione uma existente ou digite uma nova)</span>
                </label>
                <div class="space-y-2">
                    <select id="categoryL1Select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="">💡 Selecione uma categoria existente</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <input type="text" id="categoryL1" name="category_l1" placeholder="✏️  Ou digite uma nova categoria" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Categoria L2
                    <span class="text-xs text-gray-500 font-normal">(Selecione uma existente ou digite uma nova)</span>
                </label>
                <div class="space-y-2">
                    <select id="categoryL2Select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="">💡 Selecione uma categoria existente</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <input type="text" id="categoryL2" name="category_l2" placeholder="✏️  Ou digite uma nova categoria" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Categoria L3
                    <span class="text-xs text-gray-500 font-normal">(Selecione uma existente ou digite uma nova)</span>
                </label>
                <div class="space-y-2">
                    <select id="categoryL3Select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="">💡 Selecione uma categoria existente</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <input type="text" id="categoryL3" name="category_l3" placeholder="✏️  Ou digite uma nova categoria" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Meta Categoria
                    <span class="text-xs text-gray-500 font-normal">(Selecione uma existente ou digite uma nova)</span>
                </label>
                <div class="space-y-2">
                    <select id="metaCategorySelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="">💡 Selecione uma categoria existente</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <input type="text" id="metaCategory" name="meta_category" placeholder="✏️  Ou digite uma nova categoria" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-save mr-2"></i>
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4">
        <div class="text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirmar Exclusão</h3>
            <p class="text-gray-600 mb-6">Tem certeza que deseja excluir esta categoria? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center space-x-3">
                <button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancelar
                </button>
                <button onclick="confirmDelete()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Excluir
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let categoriesData = [];
let filteredCategories = [];
let currentPage = 1;
let itemsPerPage = 10;
let editingCategory = null;
let deletingCategoryId = null;

// Initialize categories page
document.addEventListener('DOMContentLoaded', function() {
    loadCategoriesData();
    setupFilters();
    setupForm();
});

async function loadCategoriesData() {
    try {
        const data = await apiRequest('/api/categories');
        categoriesData = data;
        filteredCategories = categoriesData;
        populateFilterOptions();
        renderCategoriesTable();
        showToast('Categorias carregadas com sucesso!', 'success');
    } catch (error) {
        showToast('Erro ao carregar categorias', 'error');
        console.error('Error loading categories:', error);
    }
}

function populateFilterOptions() {
    // Populate Macro Category filter
    const macroCategories = [...new Set(categoriesData.map(c => c.macro_category).filter(Boolean))].sort();
    const macroCategorySelect = document.getElementById('macroCategoryFilter');
    macroCategorySelect.innerHTML = '<option value="">Todas</option>';
    macroCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        macroCategorySelect.appendChild(option);
    });
    
    // Populate Category L1 filter
    const categoryL1s = [...new Set(categoriesData.map(c => c.category_l1).filter(Boolean))].sort();
    const categoryL1Select = document.getElementById('categoryL1Filter');
    categoryL1Select.innerHTML = '<option value="">Todas</option>';
    categoryL1s.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryL1Select.appendChild(option);
    });
    
    // Populate Meta Category filter
    const metaCategories = [...new Set(categoriesData.map(c => c.meta_category).filter(Boolean))].sort();
    const metaCategorySelect = document.getElementById('metaCategoryFilter');
    metaCategorySelect.innerHTML = '<option value="">Todas</option>';
    metaCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        metaCategorySelect.appendChild(option);
    });
    
    // Populate form dropdown options
    populateFormDropdowns();
}

function populateFormDropdowns() {
    // Get unique categories for each level
    const macroCategories = [...new Set(categoriesData.map(c => c.macro_category).filter(Boolean))].sort();
    const categoryL1s = [...new Set(categoriesData.map(c => c.category_l1).filter(Boolean))].sort();
    const categoryL2s = [...new Set(categoriesData.map(c => c.category_l2).filter(Boolean))].sort();
    const categoryL3s = [...new Set(categoriesData.map(c => c.category_l3).filter(Boolean))].sort();
    const metaCategories = [...new Set(categoriesData.map(c => c.meta_category).filter(Boolean))].sort();
    
    // Populate Macro Category dropdown
    const macroCategoryFormSelect = document.getElementById('macroCategorySelect');
    macroCategoryFormSelect.innerHTML = '<option value="">Selecione uma categoria existente</option>';
    macroCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        macroCategoryFormSelect.appendChild(option);
    });
    
    // Populate Category L1 dropdown
    const categoryL1FormSelect = document.getElementById('categoryL1Select');
    categoryL1FormSelect.innerHTML = '<option value="">Selecione uma categoria existente</option>';
    categoryL1s.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryL1FormSelect.appendChild(option);
    });
    
    // Populate Category L2 dropdown
    const categoryL2FormSelect = document.getElementById('categoryL2Select');
    categoryL2FormSelect.innerHTML = '<option value="">Selecione uma categoria existente</option>';
    categoryL2s.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryL2FormSelect.appendChild(option);
    });
    
    // Populate Category L3 dropdown
    const categoryL3FormSelect = document.getElementById('categoryL3Select');
    categoryL3FormSelect.innerHTML = '<option value="">Selecione uma categoria existente</option>';
    categoryL3s.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryL3FormSelect.appendChild(option);
    });
    
    // Populate Meta Category dropdown
    const metaCategoryFormSelect = document.getElementById('metaCategorySelect');
    metaCategoryFormSelect.innerHTML = '<option value="">Selecione uma categoria existente</option>';
    metaCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        metaCategoryFormSelect.appendChild(option);
    });
}

function renderCategoriesTable() {
    const tbody = document.getElementById('categoriesTableBody');
    tbody.innerHTML = '';
    
    // Get filter values
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const locationFilter = document.getElementById('locationFilter').value;
    const macroCategoryFilter = document.getElementById('macroCategoryFilter').value;
    const categoryL1Filter = document.getElementById('categoryL1Filter').value;
    const metaCategoryFilter = document.getElementById('metaCategoryFilter').value;
    
    // Apply filters
    filteredCategories = categoriesData.filter(category => {
        const matchesSearch = !searchInput || 
            category.ticker.toLowerCase().includes(searchInput) ||
            (category.macro_category && category.macro_category.toLowerCase().includes(searchInput)) ||
            (category.category_l1 && category.category_l1.toLowerCase().includes(searchInput)) ||
            (category.category_l2 && category.category_l2.toLowerCase().includes(searchInput)) ||
            (category.meta_category && category.meta_category.toLowerCase().includes(searchInput));
        
        const matchesLocation = !locationFilter || category.location === locationFilter;
        const matchesMacroCategory = !macroCategoryFilter || category.macro_category === macroCategoryFilter;
        const matchesCategoryL1 = !categoryL1Filter || category.category_l1 === categoryL1Filter;
        const matchesMetaCategory = !metaCategoryFilter || category.meta_category === metaCategoryFilter;
        
        return matchesSearch && matchesLocation && matchesMacroCategory && matchesCategoryL1 && matchesMetaCategory;
    });
    
    // Sort by ticker
    filteredCategories.sort((a, b) => a.ticker.localeCompare(b.ticker));
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedData = filteredCategories.slice(startIndex, endIndex);
    
    if (paginatedData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <p class="text-lg font-medium mb-2">Nenhuma categoria encontrada</p>
                    <p class="text-sm">Tente ajustar os filtros ou criar uma nova categoria</p>
                </td>
            </tr>
        `;
        return;
    }
    
    paginatedData.forEach(category => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="text-sm font-medium text-gray-900">${category.ticker}</div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${category.location === 'BR' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                    ${category.location === 'BR' ? 'Brasil' : 'Exterior'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${category.macro_category || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${category.category_l1 || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${category.category_l2 || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${category.meta_category || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
                <div class="flex items-center justify-center space-x-2">
                    <button onclick="editCategory(${category.id})" class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50 transition-colors" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteCategory(${category.id})" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50 transition-colors" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    updatePagination();
}

function updatePagination() {
    const total = filteredCategories.length;
    const totalData = categoriesData.length;
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, total);
    
    const pageInfoText = total > 0 ? `${startIndex}-${endIndex} de ${total}` : '0 de 0';
    document.getElementById('pageInfo').textContent = pageInfoText;
    
    // Update total count indicator
    const totalCountElement = document.getElementById('totalCount');
    if (total < totalData) {
        totalCountElement.textContent = `${total} de ${totalData} categorias`;
        totalCountElement.classList.remove('bg-gray-100', 'text-gray-600');
        totalCountElement.classList.add('bg-blue-100', 'text-blue-700');
    } else {
        totalCountElement.textContent = `${totalData} categorias`;
        totalCountElement.classList.remove('bg-blue-100', 'text-blue-700');
        totalCountElement.classList.add('bg-gray-100', 'text-gray-600');
    }
    
    // Update filter status
    updateFilterStatus();
    
    // Update pagination buttons
    updatePaginationButtons();
}

function updateFilterStatus() {
    const searchValue = document.getElementById('searchInput').value;
    const locationValue = document.getElementById('locationFilter').value;
    const macroCategoryValue = document.getElementById('macroCategoryFilter').value;
    const categoryL1Value = document.getElementById('categoryL1Filter').value;
    const metaCategoryValue = document.getElementById('metaCategoryFilter').value;
    
    const activeFilters = [];
    if (searchValue) activeFilters.push(`Busca: "${searchValue}"`);
    if (locationValue) activeFilters.push(`Localização: ${locationValue === 'BR' ? 'Brasil' : 'Exterior'}`);
    if (macroCategoryValue) activeFilters.push(`Macro: ${macroCategoryValue}`);
    if (categoryL1Value) activeFilters.push(`Cat. L1: ${categoryL1Value}`);
    if (metaCategoryValue) activeFilters.push(`Meta: ${metaCategoryValue}`);
    
    const filterStatus = document.getElementById('filterStatus');
    const clearButton = document.querySelector('button[onclick="clearAllFilters()"]');
    
    if (activeFilters.length > 0) {
        filterStatus.textContent = `Filtros ativos (${activeFilters.length}): ${activeFilters.join(', ')}`;
        filterStatus.classList.remove('hidden');
        clearButton.classList.remove('text-gray-600', 'hover:text-gray-800');
        clearButton.classList.add('text-blue-600', 'hover:text-blue-800', 'bg-blue-50');
    } else {
        filterStatus.classList.add('hidden');
        clearButton.classList.remove('text-blue-600', 'hover:text-blue-800', 'bg-blue-50');
        clearButton.classList.add('text-gray-600', 'hover:text-gray-800');
    }
}

function setupFilters() {
    const searchInput = document.getElementById('searchInput');
    const locationFilter = document.getElementById('locationFilter');
    const macroCategoryFilter = document.getElementById('macroCategoryFilter');
    const categoryL1Filter = document.getElementById('categoryL1Filter');
    const metaCategoryFilter = document.getElementById('metaCategoryFilter');
    
    // Add event listeners for all filters
    [searchInput, locationFilter, macroCategoryFilter, categoryL1Filter, metaCategoryFilter].forEach(filter => {
        filter.addEventListener('input', () => {
            currentPage = 1;
            renderCategoriesTable();
        });
        
        filter.addEventListener('change', () => {
            currentPage = 1;
            renderCategoriesTable();
        });
    });
}

function setupForm() {
    const form = document.getElementById('categoryForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveCategory();
    });
    
    // Setup dropdown handlers
    setupFormDropdownHandlers();
}

function setupFormDropdownHandlers() {
    // Setup handlers for form dropdowns
    document.getElementById('macroCategorySelect').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('macroCategory').value = this.value;
        }
    });
    
    document.getElementById('categoryL1Select').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('categoryL1').value = this.value;
        }
    });
    
    document.getElementById('categoryL2Select').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('categoryL2').value = this.value;
        }
    });
    
    document.getElementById('categoryL3Select').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('categoryL3').value = this.value;
        }
    });
    
    document.getElementById('metaCategorySelect').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('metaCategory').value = this.value;
        }
    });
}

function openModal(category = null) {
    editingCategory = category;
    const modal = document.getElementById('categoryModal');
    const modalTitle = document.getElementById('modalTitle');
    
    if (category) {
        modalTitle.textContent = 'Editar Categoria';
        document.getElementById('ticker').value = category.ticker;
        document.getElementById('location').value = category.location;
        document.getElementById('macroCategory').value = category.macro_category || '';
        document.getElementById('categoryL1').value = category.category_l1 || '';
        document.getElementById('categoryL2').value = category.category_l2 || '';
        document.getElementById('categoryL3').value = category.category_l3 || '';
        document.getElementById('metaCategory').value = category.meta_category || '';
        
        // Set dropdown values to match the current values
        document.getElementById('macroCategorySelect').value = category.macro_category || '';
        document.getElementById('categoryL1Select').value = category.category_l1 || '';
        document.getElementById('categoryL2Select').value = category.category_l2 || '';
        document.getElementById('categoryL3Select').value = category.category_l3 || '';
        document.getElementById('metaCategorySelect').value = category.meta_category || '';
        
        // Disable ticker editing when editing existing category
        document.getElementById('ticker').disabled = true;
    } else {
        modalTitle.textContent = 'Nova Categoria';
        document.getElementById('categoryForm').reset();
        
        // Reset all dropdowns
        document.getElementById('macroCategorySelect').value = '';
        document.getElementById('categoryL1Select').value = '';
        document.getElementById('categoryL2Select').value = '';
        document.getElementById('categoryL3Select').value = '';
        document.getElementById('metaCategorySelect').value = '';
        
        document.getElementById('ticker').disabled = false;
    }
    
    modal.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('categoryModal').classList.add('hidden');
    editingCategory = null;
}

async function saveCategory() {
    const formData = new FormData(document.getElementById('categoryForm'));
    const categoryData = Object.fromEntries(formData.entries());
    
    try {
        if (editingCategory) {
            // Update existing category
            await apiRequest(`/api/categories/${editingCategory.id}`, {
                method: 'PUT',
                body: JSON.stringify(categoryData)
            });
            showToast('Categoria atualizada com sucesso!', 'success');
        } else {
            // Create new category
            await apiRequest('/api/categories', {
                method: 'POST',
                body: JSON.stringify(categoryData)
            });
            showToast('Categoria criada com sucesso!', 'success');
        }
        
        closeModal();
        await loadCategoriesData();
    } catch (error) {
        showToast('Erro ao salvar categoria', 'error');
        console.error('Error saving category:', error);
    }
}

function editCategory(categoryId) {
    const category = categoriesData.find(c => c.id === categoryId);
    if (category) {
        openModal(category);
    }
}

function deleteCategory(categoryId) {
    deletingCategoryId = categoryId;
    document.getElementById('confirmModal').classList.remove('hidden');
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.add('hidden');
    deletingCategoryId = null;
}

async function confirmDelete() {
    if (!deletingCategoryId) return;
    
    try {
        await apiRequest(`/api/categories/${deletingCategoryId}`, {
            method: 'DELETE'
        });
        
        showToast('Categoria excluída com sucesso!', 'success');
        closeConfirmModal();
        await loadCategoriesData();
    } catch (error) {
        showToast('Erro ao excluir categoria', 'error');
        console.error('Error deleting category:', error);
    }
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        renderCategoriesTable();
    }
    updatePaginationButtons();
}

function nextPage() {
    const totalPages = Math.ceil(filteredCategories.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderCategoriesTable();
    }
    updatePaginationButtons();
}

function updatePaginationButtons() {
    const totalPages = Math.ceil(filteredCategories.length / itemsPerPage);
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    
    // Update previous button
    if (currentPage <= 1) {
        prevButton.disabled = true;
        prevButton.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        prevButton.disabled = false;
        prevButton.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    // Update next button
    if (currentPage >= totalPages) {
        nextButton.disabled = true;
        nextButton.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        nextButton.disabled = false;
        nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

function clearAllFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('locationFilter').value = '';
    document.getElementById('macroCategoryFilter').value = '';
    document.getElementById('categoryL1Filter').value = '';
    document.getElementById('metaCategoryFilter').value = '';
    
    currentPage = 1;
    renderCategoriesTable();
    
    showToast('Filtros limpos com sucesso!', 'success');
}
</script>
{% endblock %}
