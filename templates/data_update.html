{% extends "base.html" %}

{% block title %}Atualiza√ß√£o de Dados - Meu Patrim√¥nio{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Atualiza√ß√£o de Dados</h1>
    <p class="text-gray-600 mt-2">Gerencie e atualize os dados do seu portf√≥lio usando as Edge Functions do Supabase</p>
</div>

<!-- Status Bar -->
<div class="mb-6">
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Status das Atualiza√ß√µes</h2>
                <p class="text-sm text-gray-600">√öltima atualiza√ß√£o: <span id="lastUpdate">Carregando...</span></p>
            </div>
            <div class="flex items-center space-x-2">
                <div id="statusIndicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                <span id="statusText" class="text-sm text-gray-600">Verificando status...</span>
            </div>
        </div>
        <div class="mt-4">
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-xs text-gray-500 mt-1">Pronto para atualizar</p>
        </div>
    </div>
</div>

<!-- Update Actions Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
    
    <!-- Core Data Update -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="fas fa-chart-line text-xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-gray-900">Dados Principais</h3>
                <p class="text-xs text-gray-500">Alta frequ√™ncia ‚Ä¢ Di√°rio</p>
            </div>
        </div>
        <p class="text-sm text-gray-600 mb-4">
            Atualiza carteira atual e evolu√ß√£o patrimonial. Dados essenciais para o dashboard.
        </p>
        <button 
            onclick="updateCoreData()" 
            id="btnCoreData"
            class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-sync-alt mr-2"></i>
            Atualizar Principais
        </button>
        <div class="mt-3 text-xs text-gray-500" id="coreDataStatus">
            Inclui: Carteira, Patrim√¥nio, Pre√ßos
        </div>
    </div>

    <!-- Performance Update -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <i class="fas fa-trending-up text-xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-gray-900">Performance</h3>
                <p class="text-xs text-gray-500">M√©dia frequ√™ncia ‚Ä¢ Semanal</p>
            </div>
        </div>
        <p class="text-sm text-gray-600 mb-4">
            Atualiza m√©tricas de performance por ativo e categoria. Dados para an√°lise avan√ßada.
        </p>
        <button 
            onclick="updatePerformance()" 
            id="btnPerformance"
            class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chart-bar mr-2"></i>
            Atualizar Performance
        </button>
        <div class="mt-3 text-xs text-gray-500" id="performanceStatus">
            Inclui: ROI, Volatilidade, Sharpe
        </div>
    </div>

    <!-- Dividends Update -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                <i class="fas fa-coins text-xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-gray-900">Proventos</h3>
                <p class="text-xs text-gray-500">Baixa frequ√™ncia ‚Ä¢ Semanal</p>
            </div>
        </div>
        <p class="text-sm text-gray-600 mb-4">
            Sincroniza hist√≥rico de dividendos e proventos recebidos.
        </p>
        <button 
            onclick="updateDividends()" 
            id="btnDividends"
            class="w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-money-bill-wave mr-2"></i>
            Atualizar Proventos
        </button>
        <div class="mt-3 text-xs text-gray-500" id="dividendsStatus">
            Inclui: Dividendos, JCP, Bonifica√ß√µes
        </div>
    </div>

    <!-- Transactions Update -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-red-100 text-red-600">
                <i class="fas fa-exchange-alt text-xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-gray-900">Transa√ß√µes</h3>
                <p class="text-xs text-gray-500">Baix√≠ssima frequ√™ncia ‚Ä¢ Mensal</p>
            </div>
        </div>
        <p class="text-sm text-gray-600 mb-4">
            Busca completa de todas as transa√ß√µes. Processo mais demorado.
        </p>
        <button 
            onclick="updateTransactions()" 
            id="btnTransactions"
            class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-history mr-2"></i>
            Atualizar Transa√ß√µes
        </button>
        <div class="mt-3 text-xs text-gray-500" id="transactionsStatus">
            Inclui: Compras, Vendas, Hist√≥rico
        </div>
    </div>
</div>

<!-- Full Update Section -->
<div class="bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg shadow-lg p-4 sm:p-6 mb-6 sm:mb-8">
    <div class="text-white">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-2xl font-bold">Atualiza√ß√£o Completa</h2>
                <p class="text-purple-100">Executa todas as fun√ß√µes em sequ√™ncia otimizada</p>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold" id="fullUpdateTimer">--:--</div>
                <div class="text-purple-100 text-sm">Tempo estimado</div>
            </div>
        </div>
        <div class="flex items-center justify-between">
            <div class="flex-1 mr-4">
                <p class="text-sm text-purple-100 mb-2">
                    Recomendado para sincroniza√ß√£o completa dos dados. 
                    Pode levar alguns minutos dependendo do volume de dados.
                </p>
                <div class="flex items-center space-x-2 text-xs text-purple-200">
                    <span>üìä Principais</span>
                    <span>‚Üí</span>
                    <span>üìà Performance</span>
                    <span>‚Üí</span>
                    <span>üí∞ Proventos</span>
                    <span>‚Üí</span>
                    <span>üîÑ Transa√ß√µes</span>
                </div>
            </div>
            <button 
                onclick="updateAll()" 
                id="btnUpdateAll"
                class="px-8 py-3 bg-white text-purple-600 font-semibold rounded-lg hover:bg-purple-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-rocket mr-2"></i>
                Atualizar Tudo
            </button>
        </div>
    </div>
</div>

<!-- Activity Log -->
<div class="bg-white rounded-lg shadow-lg overflow-hidden card-shadow">
    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900">Log de Atividades</h2>
            <button onclick="clearLog()" class="text-sm text-gray-500 hover:text-gray-700">
                <i class="fas fa-trash mr-1"></i>
                Limpar Log
            </button>
        </div>
    </div>
    <div class="responsive-table">
        <div class="p-4 sm:p-6">
            <div id="activityLog" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="flex items-center text-sm text-gray-500">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span>Pronto para come√ßar as atualiza√ß√µes...</span>
                    <span class="ml-auto text-xs">${new Date().toLocaleTimeString('pt-BR')}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Section -->
<div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <i class="fas fa-info-circle text-blue-500 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-lg font-medium text-blue-900">Sobre as Atualiza√ß√µes</h3>
            <div class="mt-2 text-sm text-blue-700">
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>Dados Principais:</strong> Atualize diariamente para manter o dashboard preciso</li>
                    <li><strong>Performance:</strong> Execute semanalmente para an√°lise de tend√™ncias</li>
                    <li><strong>Proventos:</strong> Atualize conforme recebimento de dividendos</li>
                    <li><strong>Transa√ß√µes:</strong> Execute mensalmente ou ap√≥s grandes mudan√ßas na carteira</li>
                </ul>
                <p class="mt-3">
                    <strong>Dica:</strong> Use "Atualizar Tudo" apenas quando necess√°rio, pois consome mais recursos.
                </p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Configuration
const SUPABASE_URL = 'https://ogxgeavweqnwzebvgsyn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9neGdlYXZ3ZXFud3plYnZnc3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1ODE1MTgsImV4cCI6MjA2NzE1NzUxOH0.hVrCDLrYJCIP9QA0FFd27OtGVPGNhQhHmOiqnvjL8YY';

// State management
let isUpdating = false;
let currentStep = 0;
let totalSteps = 4;
let updateStartTime = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateLastUpdateTime();
    setInterval(updateLastUpdateTime, 30000); // Update every 30 seconds
});

// Update functions
async function updateCoreData() {
    await executeUpdate('update-core-data', 'btnCoreData', 'Dados Principais', 'coreDataStatus');
}

async function updatePerformance() {
    await executeUpdate('update-performance', 'btnPerformance', 'Performance', 'performanceStatus');
}

async function updateDividends() {
    await executeUpdate('update-dividends', 'btnDividends', 'Proventos', 'dividendsStatus');
}

async function updateTransactions() {
    await executeUpdate('update-transactions', 'btnTransactions', 'Transa√ß√µes', 'transactionsStatus');
}

async function updateAll() {
    if (isUpdating) return;
    
    isUpdating = true;
    updateStartTime = new Date();
    currentStep = 0;
    
    // Disable all buttons
    toggleAllButtons(false);
    
    // Update UI
    updateStatus('Iniciando atualiza√ß√£o completa...', 'updating');
    addLogEntry('üöÄ Iniciando atualiza√ß√£o completa do sistema', 'info');
    
    try {
        // Execute updates in sequence
        const updates = [
            { func: 'update-core-data', name: 'Dados Principais', icon: 'üìä' },
            { func: 'update-performance', name: 'Performance', icon: 'üìà' },
            { func: 'update-dividends', name: 'Proventos', icon: 'üí∞' },
            { func: 'update-transactions', name: 'Transa√ß√µes', icon: 'üîÑ' }
        ];
        
        for (let i = 0; i < updates.length; i++) {
            currentStep = i + 1;
            const update = updates[i];
            
            updateProgress((currentStep / totalSteps) * 100, `Executando ${update.name}...`);
            addLogEntry(`${update.icon} Iniciando: ${update.name}`, 'info');
            
            const result = await callSupabaseFunction(update.func);
            
            if (result.success) {
                addLogEntry(`${update.icon} ‚úÖ ${update.name} conclu√≠do com sucesso`, 'success');
            } else {
                addLogEntry(`${update.icon} ‚ùå Erro em ${update.name}: ${result.error}`, 'error');
            }
        }
        
        // Complete
        updateProgress(100, 'Atualiza√ß√£o completa finalizada!');
        updateStatus('Todas as atualiza√ß√µes conclu√≠das', 'success');
        addLogEntry('üéâ Atualiza√ß√£o completa finalizada com sucesso!', 'success');
        
        // Show completion time
        const duration = new Date() - updateStartTime;
        const minutes = Math.floor(duration / 60000);
        const seconds = Math.floor((duration % 60000) / 1000);
        addLogEntry(`‚è±Ô∏è Tempo total: ${minutes}m ${seconds}s`, 'info');
        
    } catch (error) {
        updateStatus('Erro durante atualiza√ß√£o completa', 'error');
        addLogEntry(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
    } finally {
        isUpdating = false;
        toggleAllButtons(true);
        
        // Reset progress after 3 seconds
        setTimeout(() => {
            updateProgress(0, 'Pronto para pr√≥xima atualiza√ß√£o');
            updateStatus('Sistema pronto', 'idle');
        }, 3000);
    }
}

// Core execution function
async function executeUpdate(functionName, buttonId, displayName, statusId) {
    if (isUpdating) return;
    
    const button = document.getElementById(buttonId);
    const status = document.getElementById(statusId);
    
    // Update UI
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando...`;
    status.textContent = 'Processando...';
    
    addLogEntry(`üîÑ Iniciando: ${displayName}`, 'info');
    updateStatus(`Atualizando ${displayName}...`, 'updating');
    
    try {
        const result = await callSupabaseFunction(functionName);
        
        if (result.success) {
            addLogEntry(`‚úÖ ${displayName} atualizado com sucesso`, 'success');
            status.textContent = `Atualizado ${new Date().toLocaleTimeString('pt-BR')}`;
            updateStatus(`${displayName} atualizado`, 'success');
            
            // Show success toast
            showToast(`${displayName} atualizado com sucesso!`, 'success');
        } else {
            throw new Error(result.error || 'Erro desconhecido');
        }
        
    } catch (error) {
        addLogEntry(`‚ùå Erro em ${displayName}: ${error.message}`, 'error');
        status.textContent = 'Erro na atualiza√ß√£o';
        updateStatus(`Erro: ${displayName}`, 'error');
        
        // Show error toast
        showToast(`Erro ao atualizar ${displayName}: ${error.message}`, 'error');
    } finally {
        // Reset button
        button.disabled = false;
        button.innerHTML = `<i class="fas fa-sync-alt mr-2"></i>Atualizar ${displayName.split(' ')[0]}`;
        
        // Reset status after 3 seconds
        setTimeout(() => {
            if (!isUpdating) {
                updateStatus('Sistema pronto', 'idle');
            }
        }, 3000);
    }
}

// Supabase function caller
async function callSupabaseFunction(functionName) {
    try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/${functionName}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: 'Functions' })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return { success: true, data };
        
    } catch (error) {
        console.error(`Error calling ${functionName}:`, error);
        return { success: false, error: error.message };
    }
}

// UI Helper functions
function updateStatus(message, type) {
    const indicator = document.getElementById('statusIndicator');
    const text = document.getElementById('statusText');
    
    text.textContent = message;
    
    // Reset classes
    indicator.className = 'w-3 h-3 rounded-full';
    
    switch (type) {
        case 'updating':
            indicator.classList.add('bg-blue-500', 'animate-pulse');
            break;
        case 'success':
            indicator.classList.add('bg-green-500');
            break;
        case 'error':
            indicator.classList.add('bg-red-500');
            break;
        default:
            indicator.classList.add('bg-gray-400');
    }
}

function updateProgress(percentage, text) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressBar.style.width = `${percentage}%`;
    progressText.textContent = text;
}

function addLogEntry(message, type) {
    const log = document.getElementById('activityLog');
    const entry = document.createElement('div');
    entry.className = 'flex items-center text-sm';
    
    let iconClass = 'fas fa-info-circle';
    let textClass = 'text-gray-600';
    
    switch (type) {
        case 'success':
            iconClass = 'fas fa-check-circle';
            textClass = 'text-green-600';
            break;
        case 'error':
            iconClass = 'fas fa-exclamation-circle';
            textClass = 'text-red-600';
            break;
        case 'info':
            iconClass = 'fas fa-info-circle';
            textClass = 'text-blue-600';
            break;
    }
    
    entry.innerHTML = `
        <i class="${iconClass} mr-2 ${textClass}"></i>
        <span class="${textClass}">${message}</span>
        <span class="ml-auto text-xs text-gray-400">${new Date().toLocaleTimeString('pt-BR')}</span>
    `;
    
    log.insertBefore(entry, log.firstChild);
    
    // Keep only last 50 entries
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

function toggleAllButtons(enabled) {
    const buttons = ['btnCoreData', 'btnPerformance', 'btnDividends', 'btnTransactions', 'btnUpdateAll'];
    buttons.forEach(id => {
        document.getElementById(id).disabled = !enabled;
    });
}

function updateLastUpdateTime() {
    // This would ideally fetch from your database
    // For now, using localStorage as a simple cache
    const lastUpdate = localStorage.getItem('lastDataUpdate') || 'Nunca';
    document.getElementById('lastUpdate').textContent = lastUpdate;
}

function clearLog() {
    const log = document.getElementById('activityLog');
    log.innerHTML = `
        <div class="flex items-center text-sm text-gray-500">
            <i class="fas fa-info-circle mr-2"></i>
            <span>Log limpo - Pronto para novas atualiza√ß√µes...</span>
            <span class="ml-auto text-xs">${new Date().toLocaleTimeString('pt-BR')}</span>
        </div>
    `;
}

// Timer update for full update
setInterval(() => {
    if (isUpdating && updateStartTime) {
        const elapsed = new Date() - updateStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('fullUpdateTimer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
        document.getElementById('fullUpdateTimer').textContent = '--:--';
    }
}, 1000);
</script>
{% endblock %}
