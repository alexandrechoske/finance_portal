{% extends 'base.html' %}
{% block title %}Freelas & Ganhos Extras{% endblock %}
{% block content %}
<div class="mb-6">
  <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-laptop-code text-blue-600"></i> Ganhos Freelance / Extras</h2>
  <p class="text-gray-600 mt-1">AnÃ¡lise de receitas externas (consultorias, freelas, etc.)</p>
</div>

<!-- Mensagem de carregamento especÃ­fico da pÃ¡gina -->
<div id="freelasLoadingMsg" class="mb-4 p-3 bg-blue-50 border border-blue-200 text-blue-700 rounded flex items-center gap-2 hidden">
  <i class="fas fa-spinner fa-spin"></i>
  <span id="freelasLoadingText">Carregando dados de freelas... pode levar alguns segundos.</span>
</div>

<!-- Filtros -->
<div class="bg-white p-4 rounded-lg shadow mb-6 grid md:grid-cols-4 gap-4">
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">MÃªs</label>
    <select id="filterMonth" class="w-full border rounded px-2 py-1">
      <option value="">Todos</option>
    </select>
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
    <select id="filterTipo" class="w-full border rounded px-2 py-1">
      <option value="">Todos</option>
    </select>
  </div>
  <div class="md:col-span-2">
    <label class="block text-sm font-medium text-gray-700 mb-1">Busca (DescriÃ§Ã£o)</label>
    <input id="filterSearch" type="text" placeholder="Nome / palavra-chave" class="w-full border rounded px-2 py-1" />
  </div>
  <div class="md:col-span-4 flex justify-end gap-2">
    <button id="btnReload" title="Recarregar dados da fonte" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow flex items-center gap-2"><i class="fas fa-rotate-right"></i><span class="hidden sm:inline">Recarregar</span></button>
    <button id="btnApplyFilters" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">Aplicar</button>
    <button id="btnResetFilters" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded shadow">Limpar</button>
  </div>
</div>

<!-- Cards Resumo -->
<div class="grid md:grid-cols-4 gap-4 mb-6">
  <div class="bg-white p-4 rounded shadow">
    <h4 class="text-sm text-gray-500">Total Geral</h4>
    <div id="cardTotalGeral" class="text-2xl font-bold text-gray-800">-</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h4 class="text-sm text-gray-500">Total Filtrado</h4>
    <div id="cardTotalFiltrado" class="text-2xl font-bold text-gray-800">-</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h4 class="text-sm text-gray-500">Primeiro Lcto</h4>
    <div id="cardFirstDate" class="text-lg font-semibold text-gray-700">-</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <h4 class="text-sm text-gray-500">Ãšltimo Lcto</h4>
    <div id="cardLastDate" class="text-lg font-semibold text-gray-700">-</div>
  </div>
</div>

<!-- GrÃ¡ficos -->
<div class="flex flex-col lg:flex-row gap-6 mb-6">
  <div class="bg-white p-4 rounded-xl shadow flex-1 lg:basis-4/5 relative overflow-hidden">
    <div class="absolute -right-8 -top-8 opacity-5 text-8xl select-none">ðŸ“Š</div>
    <h3 class="font-semibold mb-3 flex items-center gap-2"><span class="w-2 h-2 bg-blue-500 rounded-full"></span> EvoluÃ§Ã£o Mensal (Filtrado)</h3>
    <div class="h-80">
      <canvas id="chartMonthly"></canvas>
    </div>
  </div>
  <div class="bg-white p-4 rounded-xl shadow w-full lg:w-1/5 lg:max-w-xs relative overflow-hidden">
    <div class="absolute -right-6 -top-6 opacity-5 text-8xl select-none">ðŸ§©</div>
    <h3 class="font-semibold mb-3 flex items-center gap-2"><span class="w-2 h-2 bg-indigo-500 rounded-full"></span> DistribuiÃ§Ã£o por Tipo</h3>
    <div class="h-80 flex items-center justify-center">
      <canvas id="chartTipo"></canvas>
    </div>
  </div>
</div>

<!-- Tabela -->
<div class="bg-white p-4 rounded-xl shadow">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <h3 class="font-semibold text-lg flex items-center gap-2"><i class="fas fa-table text-blue-500"></i> Registros</h3>
    <div class="flex items-center gap-4 text-sm">
      <div><span class="font-medium">Total:</span> <span id="regCount" class="text-gray-600">0</span></div>
      <div class="flex items-center gap-1">
        <label for="pageSize" class="text-gray-500">Por pÃ¡gina</label>
        <select id="pageSize" class="border rounded px-1 py-0.5 text-sm">
          <option>10</option>
          <option selected>25</option>
          <option>50</option>
          <option>100</option>
        </select>
      </div>
    </div>
  </div>
  <div class="responsive-table rounded border border-gray-100">
    <table class="min-w-full text-sm" id="tblFreelas">
      <thead class="bg-gray-50 text-xs uppercase tracking-wide text-gray-600">
        <tr>
          <th id="thData" class="px-3 py-2 text-left font-medium cursor-pointer select-none hover:bg-gray-100 group">Data <i class="fas fa-sort text-gray-400 group-hover:text-gray-600"></i></th>
          <th class="px-3 py-2 text-left font-medium">MÃªs</th>
            <th class="px-3 py-2 text-left font-medium">DescriÃ§Ã£o</th>
          <th class="px-3 py-2 text-left font-medium">Tipo</th>
          <th class="px-3 py-2 text-right font-medium">Valor</th>
        </tr>
      </thead>
      <tbody id="tblBody" class="divide-y divide-gray-100"></tbody>
    </table>
  </div>
  <div class="flex flex-col sm:flex-row items-center justify-between gap-3 mt-4 text-sm">
    <div id="paginationInfo" class="text-gray-600"></div>
    <div class="flex items-center gap-2" id="paginationControls"></div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let monthlyChart = null;
let tipoChart = null;
let allRecords = [];
let currentPage = 1;
let pageSize = 25;
let currentSortDir = 'desc'; // desc = mais recente primeiro
let baseRecords = []; // dataset completo carregado 1x
let baseAggregations = null;
let baseLastUpdated = null;

function formatBRL(v){
  return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
}

function buildSelectOptions(selectEl, values, includeEmpty=true){
  const current = selectEl.value;
  selectEl.innerHTML = '';
  if(includeEmpty){
    const opt = document.createElement('option');
    opt.value=''; opt.textContent='Todos';
    selectEl.appendChild(opt);
  }
  values.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v; opt.textContent = v;
    if(v===current) opt.selected = true;
    selectEl.appendChild(opt);
  });
}

function sortRecords(){
  allRecords.sort((a,b)=>{
    const da = a.data_lancamento || '';
    const db = b.data_lancamento || '';
    if(da===db) return 0;
    if(currentSortDir==='desc') return da<db?1:-1; // mais recente primeiro
    return da>db?1:-1;
  });
}

function renderTablePage(){
  const tbody = document.getElementById('tblBody');
  tbody.innerHTML='';
  const start = (currentPage-1)*pageSize;
  const pageRecords = allRecords.slice(start, start+pageSize);
  pageRecords.forEach(r=>{
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-blue-50 transition-colors';
    tr.innerHTML = `
      <td class="px-3 py-2 whitespace-nowrap font-medium text-gray-700">${r.data_lancamento || ''}</td>
      <td class="px-3 py-2">${r.mes || ''}</td>
      <td class="px-3 py-2">${r.descricao}</td>
      <td class="px-3 py-2"><span class="inline-block px-2 py-0.5 rounded-full text-xs bg-indigo-100 text-indigo-700">${r.tipo}</span></td>
      <td class="px-3 py-2 text-right font-semibold text-gray-800">${formatBRL(r.valor)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('regCount').textContent = allRecords.length + ' registro(s)';
  renderPaginationControls();
}

function renderPaginationControls(){
  const totalPages = Math.max(1, Math.ceil(allRecords.length / pageSize));
  if(currentPage>totalPages) currentPage = totalPages;
  const info = document.getElementById('paginationInfo');
  const start = (currentPage-1)*pageSize + 1;
  const end = Math.min(allRecords.length, currentPage*pageSize);
  info.textContent = `Exibindo ${start}-${end} de ${allRecords.length}`;
  const ctr = document.getElementById('paginationControls');
  ctr.innerHTML='';
  function btn(label, disabled, onClick, active=false){
    const b = document.createElement('button');
    b.textContent = label;
    b.className = 'px-3 py-1 rounded border text-sm ' + (active? 'bg-blue-600 text-white border-blue-600':'bg-white hover:bg-gray-100 text-gray-700 border-gray-300') + (disabled? ' opacity-50 cursor-not-allowed':'');
    if(!disabled) b.addEventListener('click', onClick);
    ctr.appendChild(b);
  }
  btn('Â«', currentPage===1, ()=>{currentPage=1; renderTablePage();});
  btn('â€¹', currentPage===1, ()=>{currentPage--; renderTablePage();});
  // pÃ¡ginas centrais (mÃ¡x 5)
  let startPage = Math.max(1, currentPage-2);
  let endPage = Math.min(totalPages, startPage+4);
  if(endPage-startPage<4){ startPage = Math.max(1, endPage-4);} 
  for(let p=startPage;p<=endPage;p++){
    btn(p, false, ()=>{currentPage=p; renderTablePage();}, p===currentPage);
  }
  btn('â€º', currentPage===totalPages, ()=>{currentPage++; renderTablePage();});
  btn('Â»', currentPage===totalPages, ()=>{currentPage=totalPages; renderTablePage();});
}

function buildMonthlyChart(data){
  const ctx = document.getElementById('chartMonthly').getContext('2d');
  if(monthlyChart) monthlyChart.destroy();
  const labels = Object.keys(data).sort();
  const values = labels.map(l=>data[l]);
  monthlyChart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Valor (R$)', data: values, backgroundColor:'#3B82F6' }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ 
        legend:{display:false}, 
        tooltip:{callbacks:{label:(ctx)=>formatBRL(ctx.parsed.y)}},
        datalabels:{
          anchor:'end',
            align:'end',
            color:'#1f2937',
            font:{size:11, weight:'600'},
            formatter:(v)=>formatBRL(v)
        }
      },
      layout:{padding:{top:10,right:10}}
    }
  });
}

function buildTipoChart(data){
  const ctx = document.getElementById('chartTipo').getContext('2d');
  if(tipoChart) tipoChart.destroy();
  const labels = Object.keys(data);
  const values = labels.map(l=>data[l]);
  const colors = ['#0ea5e9','#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#f97316'];
  tipoChart = new Chart(ctx, {
    type:'doughnut',
    data:{ labels, datasets:[{ data: values, backgroundColor: labels.map((_,i)=>colors[i%colors.length]), borderWidth:2, borderColor:'#ffffff' }]},
    options:{ 
      responsive:true,
      cutout:'55%',
      plugins:{ 
        legend:{position:'bottom'}, 
        tooltip:{callbacks:{label:(ctx)=>`${ctx.label}: ${formatBRL(ctx.parsed)}`}},
        datalabels:{
          color:'#fff',
          font:{size:11, weight:'600'},
          formatter:(v,ctx)=>{
            const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
            const perc = total? (v/total*100):0;
            if(perc < 4) return ''; // nÃ£o poluir
            return `${ctx.chart.data.labels[ctx.dataIndex]}\n${perc.toFixed(1)}%`;
          }
        }
      }
    }
  });
}

async function loadFreelas(){
  const pageLoader = document.getElementById('freelasLoadingMsg');
  const pageLoaderText = document.getElementById('freelasLoadingText');
  let finished = false;
  pageLoader.classList.remove('hidden');
  pageLoaderText.textContent = 'Carregando dados de freelas... pode levar alguns segundos.';
  // Mensagem prolongada se demorar >3s
  const longTimer = setTimeout(()=>{
    if(!finished){
      pageLoaderText.textContent = 'Ainda carregando... a fonte externa Ã© lenta. Aguarde mais um pouco.';
    }
  }, 3000);
  // Sempre busca sem filtros para guardar em memÃ³ria
  const url = '/api/freelas/earnings';
  let data;
  try {
    data = await apiRequest(url);
  } catch (e) {
    pageLoaderText.textContent = 'Erro ao carregar dados (' + (e.message || 'desconhecido') + ').';
    clearTimeout(longTimer);
    finished = true;
    // MantÃ©m mensagem de erro visÃ­vel
    return;
  }
  clearTimeout(longTimer);
  finished = true;
  // Guarda payload base
  baseRecords = data.records || data.data || [];
  baseAggregations = data.aggregations;
  baseLastUpdated = data.last_updated || new Date().toISOString();

  // Popular selects
  buildSelectOptions(document.getElementById('filterMonth'), baseAggregations.months_available);
  const tipos = Object.keys(baseAggregations.tipo_totals).sort();
  buildSelectOptions(document.getElementById('filterTipo'), tipos);

  // Atualiza cards com dados gerais e dispara aplicaÃ§Ã£o de filtros locais
  updateGeneralCards();
  applyLocalFilters();
  pageLoader.classList.add('hidden');
}

function updateGeneralCards(){
  if(!baseAggregations) return;
  const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  document.getElementById('cardTotalGeral').textContent = fmt.format(baseAggregations.overall_total);
  document.getElementById('cardFirstDate').textContent = baseAggregations.first_date || '-';
  document.getElementById('cardLastDate').textContent = baseAggregations.last_date || '-';
}

function applyLocalFilters(){
  if(!baseRecords.length){ return; }
  const month = document.getElementById('filterMonth').value;
  const tipo = document.getElementById('filterTipo').value;
  const search = document.getElementById('filterSearch').value.trim().toLowerCase();

  let filtered = baseRecords;
  if(month) filtered = filtered.filter(r=>r.mes === month);
  if(tipo) filtered = filtered.filter(r=>r.tipo === tipo);
  if(search) filtered = filtered.filter(r=>(r.descricao||'').toLowerCase().includes(search));

  // Recalcula agregaÃ§Ãµes filtradas
  const monthly_totals = {};
  const tipo_totals = {};
  let overall_total = 0;
  filtered.forEach(r=>{
    overall_total += r.valor;
    if(r.mes) monthly_totals[r.mes] = (monthly_totals[r.mes]||0)+r.valor;
    tipo_totals[r.tipo] = (tipo_totals[r.tipo]||0)+r.valor;
  });
  const fmt = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  document.getElementById('cardTotalFiltrado').textContent = fmt.format(overall_total);

  // Atualiza registros globais e render
  allRecords = filtered.slice();
  sortRecords();
  currentPage = 1;
  renderTablePage();
  buildMonthlyChart(monthly_totals);
  buildTipoChart(tipo_totals);
}

// Eventos
 document.getElementById('btnApplyFilters').addEventListener('click', ()=>{applyLocalFilters();});
 document.getElementById('btnResetFilters').addEventListener('click', ()=>{
   document.getElementById('filterMonth').value='';
   document.getElementById('filterTipo').value='';
   document.getElementById('filterSearch').value='';
   applyLocalFilters();
 });
 document.getElementById('btnReload').addEventListener('click', ()=>{loadFreelas();});

 // Muda page size
 document.getElementById('pageSize').addEventListener('change', (e)=>{ pageSize=parseInt(e.target.value,10)||25; currentPage=1; renderTablePage(); });
 // OrdenaÃ§Ã£o por data
 document.getElementById('thData').addEventListener('click', ()=>{ currentSortDir = currentSortDir==='desc'?'asc':'desc'; sortRecords(); currentPage=1; renderTablePage(); });

 // Auto carregar
 loadFreelas();
</script>
{% endblock %}
