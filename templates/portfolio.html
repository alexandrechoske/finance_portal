{% extends "base.html" %}

{% block title %}Detalhes da Carteira - Meu Patrimônio{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Detalhes da Carteira</h1>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Total Patrimony Card -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 card-shadow">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="fas fa-wallet text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-600 text-sm">Patrimônio Total</p>
                <p id="totalPatrimony" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
            </div>
        </div>
    </div>

    <!-- Total Cost Card -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-gray-100 text-gray-600">
                <i class="fas fa-shopping-cart text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-600 text-sm">Custo Total</p>
                <p id="totalCost" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
            </div>
        </div>
    </div>

    <!-- Performance Card -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <i class="fas fa-chart-line text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-gray-600 text-sm">Rentabilidade Real</p>
                <p id="performancePerc" class="text-2xl font-semibold text-gray-900">0,00%</p>
            </div>
        </div>
    </div>
</div>

<!-- Multi-Level Category Analysis Charts -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Macro Category Chart -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 card-shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Composição por Macro Categoria</h3>
        <div class="relative h-64">
            <canvas id="macroCategoryChart"></canvas>
        </div>
    </div>

    <!-- Category L1 Chart -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Composição por Categoria L1</h3>
        <div class="relative h-64">
            <canvas id="categoryL1Chart"></canvas>
        </div>
    </div>

    <!-- Category L2 Chart -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Composição por Categoria L2</h3>
        <div class="relative h-64">
            <canvas id="categoryL2Chart"></canvas>
        </div>
    </div>

    <!-- Category L3 Chart -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Composição por Categoria L3</h3>
        <div class="relative h-64">
            <canvas id="categoryL3Chart"></canvas>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-6 card-shadow">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Localização</label>
            <select id="locationFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Todas</option>
                <option value="BR">Brasil</option>
                <option value="EXT">Exterior</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
            <select id="categoryFilter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Todas</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ativo</label>
            <input type="text" id="tickerFilter" placeholder="Digite o ticker..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
    </div>
    <div class="mt-4 flex justify-end">
        <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2 transition-colors">
            Limpar Filtros
        </button>
        <button onclick="applyFilters()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
            Aplicar Filtros
        </button>
    </div>
</div>

<!-- Portfolio Table -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden card-shadow">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Composição da Carteira</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Local</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Médio</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Atual</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Custo Total</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Atual</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Resultado</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Rentabilidade</th>
                </tr>
            </thead>
            <tbody id="portfolioTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Portfolio data will be populated here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Loading state -->
    <div id="portfolioLoading" class="hidden bg-white rounded-lg shadow-lg p-8 sm:p-12 text-center card-shadow">
    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
    <p class="text-gray-600">Carregando dados da carteira...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
let portfolioData = [];
let filteredData = [];

// Initialize portfolio page
document.addEventListener('DOMContentLoaded', function() {
    loadPortfolioData();
    setupFilters();
});

async function loadPortfolioData() {
    try {
        // Load summary data
        const summaryData = await apiRequest('/api/summary');
        updateSummaryCards(summaryData);

        // Load portfolio details
        const portfolioDetails = await apiRequest('/api/portfolio/details');
        portfolioData = portfolioDetails;
        filteredData = portfolioData;
        
        // Load multi-category composition for analytical view
        const multiCategoryData = await apiRequest('/api/portfolio/composition-multi-category');
        updateMultiCategoryCharts(multiCategoryData);
        
        // Populate category filter
        populateCategoryFilter();
        
        // Render table
        renderPortfolioTable();
        
        showToast('Dados da carteira carregados com sucesso!', 'success');
    } catch (error) {
        showToast('Erro ao carregar dados da carteira', 'error');
        console.error('Error loading portfolio:', error);
    }
}

function updateSummaryCards(data) {
    document.getElementById('totalPatrimony').textContent = formatCurrency(data.total_patrimony);
    document.getElementById('totalCost').textContent = formatCurrency(data.total_cost);
    
    const performanceElement = document.getElementById('performancePerc');
    performanceElement.textContent = formatPercentage(data.performance_perc);
    performanceElement.className = `text-2xl font-semibold ${data.performance_perc >= 0 ? 'performance-positive' : 'performance-negative'}`;
}

function populateCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    const categories = [...new Set(portfolioData.map(item => item.category))];
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
    });
}

function renderPortfolioTable() {
    const tbody = document.getElementById('portfolioTableBody');
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-4"></i>
                    <p>Nenhum ativo encontrado com os filtros aplicados</p>
                </td>
            </tr>
        `;
        return;
    }
    
    filteredData.forEach(asset => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        const performanceValue = asset.performance_value || 0;
        const performancePerc = asset.performance_perc || 0;
        const performanceClass = performanceValue >= 0 ? 'performance-positive' : 'performance-negative';
        
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="font-medium text-gray-900">${asset.ticker}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${asset.category}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${asset.location === 'BR' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                    ${asset.location === 'BR' ? 'Brasil' : 'Exterior'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatNumber(asset.total_symbols)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(asset.average_price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(asset.market_price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(asset.total_cost)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(asset.total_market_value)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm ${performanceClass}">${formatCurrency(performanceValue)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm ${performanceClass}">${formatPercentage(performancePerc)}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function setupFilters() {
    const locationFilter = document.getElementById('locationFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const tickerFilter = document.getElementById('tickerFilter');
    
    locationFilter.addEventListener('change', applyFilters);
    categoryFilter.addEventListener('change', applyFilters);
    tickerFilter.addEventListener('input', applyFilters);
}

function applyFilters() {
    const locationFilter = document.getElementById('locationFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const tickerFilter = document.getElementById('tickerFilter').value.toUpperCase();
    
    filteredData = portfolioData.filter(asset => {
        const matchesLocation = !locationFilter || asset.location === locationFilter;
        const matchesCategory = !categoryFilter || asset.category === categoryFilter;
        const matchesTicker = !tickerFilter || asset.ticker.toUpperCase().includes(tickerFilter);
        
        return matchesLocation && matchesCategory && matchesTicker;
    });
    
    renderPortfolioTable();
}

function clearFilters() {
    document.getElementById('locationFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('tickerFilter').value = '';
    
    filteredData = portfolioData;
    renderPortfolioTable();
}

function formatNumber(value) {
    return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(value);
}

function updateMultiCategoryCharts(data) {
    // Color palettes for each chart
    const colorPalettes = {
        macro: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#F97316', '#06B6D4'],
        l1: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#F97316', '#06B6D4'],
        l2: ['#3B82F6', '#8B5CF6', '#EF4444', '#F59E0B', '#10B981', '#EC4899', '#F97316', '#06B6D4'],
        l3: ['#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EF4444', '#EC4899', '#F97316', '#06B6D4']
    };
    
    // Garantir que sempre haja Investimento e Reserva no gráfico, mesmo que um esteja zerado
    let macroData = Array.isArray(data.macro_category) ? [...data.macro_category] : [];
    const macroNames = macroData.map(item => item.name);
    if (!macroNames.includes('Investimento')) {
        macroData.push({ name: 'Investimento', value: 0 });
    }
    if (!macroNames.includes('Reserva')) {
        macroData.push({ name: 'Reserva', value: 0 });
    }
    // Ordena para Investimento sempre vir antes de Reserva
    macroData.sort((a, b) => {
        if (a.name === 'Investimento') return -1;
        if (b.name === 'Investimento') return 1;
        if (a.name === 'Reserva') return -1;
        if (b.name === 'Reserva') return 1;
        return a.name.localeCompare(b.name);
    });
    updateCategoryChart('macroCategoryChart', macroData, colorPalettes.macro);
    
    // Update category L1 chart
    updateCategoryChart('categoryL1Chart', data.category_l1, colorPalettes.l1);
    
    // Update category L2 chart (only if has data)
    if (data.category_l2 && data.category_l2.length > 0) {
        updateCategoryChart('categoryL2Chart', data.category_l2, colorPalettes.l2);
    } else {
        showEmptyChart('categoryL2Chart', 'Nenhuma categoria L2 disponível');
    }
    
    // Update category L3 chart (only if has data)
    if (data.category_l3 && data.category_l3.length > 0) {
        updateCategoryChart('categoryL3Chart', data.category_l3, colorPalettes.l3);
    } else {
        showEmptyChart('categoryL3Chart', 'Nenhuma categoria L3 disponível');
    }
}

function updateCategoryChart(canvasId, data, colors) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart if exists
    if (window[canvasId + 'Instance']) {
        window[canvasId + 'Instance'].destroy();
    }
    
    const labels = data.map(item => item.name);
    const values = data.map(item => item.value);
    
    window[canvasId + 'Instance'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 8,
                        font: {
                            size: 10
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function showEmptyChart(canvasId, message) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart if exists
    if (window[canvasId + 'Instance']) {
        window[canvasId + 'Instance'].destroy();
    }
    
    // Clear canvas and show message
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '14px Arial';
    ctx.fillStyle = '#6B7280';
    ctx.textAlign = 'center';
    ctx.fillText(message, canvas.width / 2, canvas.height / 2);
}
</script>
{% endblock %}
