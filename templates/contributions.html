{% extends "base.html" %}

{% block title %}Transações - Meu Patrimônio{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Transações</h1>
</div>

<!-- Summary Cards Row 1 - Compras -->
<div class="mb-4">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-gray-700">📈 Compras</h2>
        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
            <i class="fas fa-filter mr-1"></i>
            Excluindo Renda Fixa
        </span>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Total Purchases Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-plus-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Total Compras</p>
                    <p id="totalPurchases" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- This Year Purchases Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-calendar-alt text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Compras (Ano)</p>
                    <p id="yearPurchases" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- This Month Purchases Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-calendar-week text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Compras (Mês)</p>
                    <p id="monthPurchases" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- Average Monthly Purchases Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                    <i class="fas fa-chart-bar text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Média Mensal</p>
                    <p id="averageMonthlyPurchases" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Row 2 - Vendas -->
<div class="mb-4">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-gray-700">📉 Vendas</h2>
        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
            <i class="fas fa-filter mr-1"></i>
            Excluindo Renda Fixa
        </span>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Total Sales Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-red-100 text-red-600">
                    <i class="fas fa-minus-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Total Vendas</p>
                    <p id="totalSales" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- This Year Sales Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                    <i class="fas fa-calendar-alt text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Vendas (Ano)</p>
                    <p id="yearSales" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- This Month Sales Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-calendar-week text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Vendas (Mês)</p>
                    <p id="monthSales" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
                </div>
            </div>
        </div>

        <!-- Net Flow Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-gray-100 text-gray-600">
                    <i class="fas fa-balance-scale text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Saldo Líquido</p>
                    <p id="netFlow" class="text-2xl font-semibold text-gray-900">R$ 0,00</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Chart Section -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-6 card-shadow">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-4 space-y-4 lg:space-y-0">
        <div>
            <h2 class="text-xl font-semibold text-gray-900">� Transações Mensais</h2>
            <p class="text-xs text-gray-500 mt-1">
                <i class="fas fa-filter mr-1"></i>
                Excluindo ativos de Renda Fixa • Compras em verde, Vendas em vermelho
            </p>
        </div>
        <div class="flex flex-wrap gap-2">
            <select id="chartYearFilter" class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Todos os anos</option>
            </select>
            <select id="chartTypeFilter" class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Compras + Vendas</option>
                <option value="Compra">Apenas Compras</option>
                <option value="Venda">Apenas Vendas</option>
            </select>
            <input type="text" id="chartTickerFilter" placeholder="Filtrar por ticker..." class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button onclick="toggleMainChartType()" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                <i class="fas fa-chart-line mr-1"></i>
                Tipo
            </button>
        </div>
    </div>
    <div class="relative h-96">
        <canvas id="mainChart"></canvas>
    </div>
</div>

<!-- Transactions History -->
<div class="bg-white rounded-lg shadow-lg overflow-hidden card-shadow">
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-900">Histórico de Transações</h2>
        <div class="flex space-x-2">
            <select id="typeFilter" class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Todos os tipos</option>
                <option value="Compra">Compra</option>
                <option value="Venda">Venda</option>
            </select>
            <input type="text" id="tickerFilter" placeholder="Filtrar por ticker..." class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button onclick="exportTransactions()" class="px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                <i class="fas fa-download mr-1"></i>
                Exportar
            </button>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticker</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Preço</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Total</th>
                </tr>
            </thead>
            <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Transactions data will be populated here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="mt-6 flex justify-between items-center">
    <div class="text-sm text-gray-700">
        Mostrando <span id="pageInfo">1-10 de 100</span> transações
    </div>
    <div class="flex space-x-2">
        <button onclick="previousPage()" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button onclick="nextPage()" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mainChart;
let purchasesData = {};
let salesData = {};
let transactionsData = [];
let filteredTransactions = [];
let currentMainChartType = 'bar';
let currentPage = 1;
let itemsPerPage = 10;
let allTransactionsForChart = [];

// Initialize transactions page
document.addEventListener('DOMContentLoaded', function() {
    loadTransactionsData();
    setupFilters();
});

async function loadTransactionsData() {
    try {
        // Load separate data for purchases and sales
        const [purchases, sales, transactions, allTransactions] = await Promise.all([
            apiRequest('/api/transactions/monthly-purchases'),
            apiRequest('/api/transactions/monthly-sales'),
            loadTransactionsTable(),
            apiRequest('/api/transactions?per_page=10000') // Get all transactions for chart filtering
        ]);
        
        purchasesData = purchases;
        salesData = sales;
        allTransactionsForChart = allTransactions.data;
        
        // Update summary cards
        updateSummaryCards();
        
        // Update chart
        updateMainChart();
        populateYearFilters();
        
        // Render transactions table
        renderTransactionsTable();
        
        showToast('Dados de transações carregados com sucesso!', 'success');
    } catch (error) {
        showToast('Erro ao carregar dados de transações', 'error');
        console.error('Error loading transactions data:', error);
    }
}

async function loadTransactionsTable() {
    try {
        const typeFilter = document.getElementById('typeFilter').value;
        const tickerFilter = document.getElementById('tickerFilter').value;
        
        const params = new URLSearchParams({
            page: currentPage,
            per_page: itemsPerPage,
            ...(typeFilter && { type: typeFilter }),
            ...(tickerFilter && { ticker: tickerFilter })
        });
        
        const response = await apiRequest(`/api/transactions?${params}`);
        transactionsData = response.data;
        filteredTransactions = transactionsData;
        
        // Update pagination info
        updatePaginationInfo(response);
        
        return response;
        
    } catch (error) {
        console.error('Error loading transactions:', error);
        transactionsData = [];
        filteredTransactions = [];
        return { data: [], total: 0, page: 1, total_pages: 1 };
    }
}

function updateMainChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    
    if (mainChart) {
        mainChart.destroy();
    }
    
    // Get filter values
    const yearFilter = document.getElementById('chartYearFilter').value;
    const typeFilter = document.getElementById('chartTypeFilter').value;
    const tickerFilter = document.getElementById('chartTickerFilter').value.toLowerCase();
    
    // Use the aggregated data from the API instead of filtering individual transactions
    // This ensures we're using the same filtered data (excluding fixed income)
    let filteredPurchasesData = { ...purchasesData };
    let filteredSalesData = { ...salesData };
    
    // Apply year filter
    if (yearFilter) {
        filteredPurchasesData = {};
        filteredSalesData = {};
        
        Object.keys(purchasesData).forEach(key => {
            if (key.startsWith(yearFilter)) {
                filteredPurchasesData[key] = purchasesData[key];
            }
        });
        
        Object.keys(salesData).forEach(key => {
            if (key.startsWith(yearFilter)) {
                filteredSalesData[key] = salesData[key];
            }
        });
    }
    
    // For ticker filter, we need to filter the individual transactions
    if (tickerFilter) {
        // Filter individual transactions and recalculate monthly data
        const filteredTransactions = allTransactionsForChart.filter(t => 
            t.ticker.toLowerCase().includes(tickerFilter)
        );
        
        // Recalculate monthly data for filtered tickers
        filteredPurchasesData = {};
        filteredSalesData = {};
        
        filteredTransactions.forEach(transaction => {
            const monthKey = transaction.transaction_date.substring(0, 7);
            
            if (yearFilter && !monthKey.startsWith(yearFilter)) {
                return; // Skip if doesn't match year filter
            }
            
            if (transaction.type === 'Compra') {
                filteredPurchasesData[monthKey] = (filteredPurchasesData[monthKey] || 0) + parseFloat(transaction.total_value || 0);
            } else if (transaction.type === 'Venda') {
                filteredSalesData[monthKey] = (filteredSalesData[monthKey] || 0) + parseFloat(transaction.total_value || 0);
            }
        });
    }
    
    // Get all unique months
    const allMonths = new Set([...Object.keys(filteredPurchasesData), ...Object.keys(filteredSalesData)]);
    const sortedMonths = Array.from(allMonths).sort();
    
    // Prepare chart data
    const purchasesValues = sortedMonths.map(month => filteredPurchasesData[month] || 0);
    const salesValues = sortedMonths.map(month => filteredSalesData[month] || 0);
    
    // Calculate average purchase line
    const totalPurchases = purchasesValues.reduce((sum, val) => sum + val, 0);
    const avgPurchases = totalPurchases / (purchasesValues.length || 1);
    const avgLine = new Array(sortedMonths.length).fill(avgPurchases);
    
    // Prepare datasets
    const datasets = [];
    
    // Add purchases dataset if not filtered to sales only
    if (typeFilter !== 'Venda') {
        datasets.push({
            label: 'Compras',
            data: purchasesValues,
            backgroundColor: '#10B981',
            borderColor: '#10B981',
            borderWidth: 2,
            type: currentMainChartType,
            yAxisID: 'y',
            order: 2
        });
    }
    
    // Add sales dataset if not filtered to purchases only
    if (typeFilter !== 'Compra') {
        datasets.push({
            label: 'Vendas',
            data: salesValues,
            backgroundColor: '#EF4444',
            borderColor: '#EF4444',
            borderWidth: 2,
            type: currentMainChartType,
            yAxisID: 'y',
            order: 3
        });
    }
    
    // Add average line for purchases if showing purchases
    if (typeFilter !== 'Venda' && avgPurchases > 0) {
        datasets.push({
            label: 'Média de Aportes',
            data: avgLine,
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderColor: '#6366F1',
            borderWidth: 2,
            borderDash: [5, 5],
            type: 'line',
            yAxisID: 'y',
            order: 1,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 6
        });
    }
    
    mainChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedMonths.map(month => formatMonthYear(month)),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            return `${label}: ${formatCurrency(value)}`;
                        }
                    }
                },
                datalabels: {
                    display: function(context) {
                        return context.dataset.type !== 'line'; // Only show labels on bars, not line
                    },
                    anchor: 'end',
                    align: 'top',
                    color: '#374151',
                    font: {
                        size: 10,
                        weight: 'bold'
                    },
                    formatter: function(value, context) {
                        if (value === 0) return '';
                        return formatCurrencyShort(value);
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Mês'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrencyShort(value);
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function formatCurrencyShort(value) {
    if (value >= 1000000) {
        return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
    } else if (value >= 1000) {
        return 'R$ ' + (value / 1000).toFixed(1) + 'k';
    } else {
        return 'R$ ' + value.toFixed(0);
    }
}

function updateSummaryCards() {
    // Calculate totals
    const totalPurchases = Object.values(purchasesData).reduce((sum, value) => sum + value, 0);
    const totalSales = Object.values(salesData).reduce((sum, value) => sum + value, 0);
    const netFlow = totalPurchases - totalSales;
    
    // Calculate current year and month
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().toISOString().substr(0, 7); // YYYY-MM format
    
    const yearPurchases = Object.keys(purchasesData)
        .filter(key => key.startsWith(currentYear.toString()))
        .reduce((sum, key) => sum + purchasesData[key], 0);
        
    const yearSales = Object.keys(salesData)
        .filter(key => key.startsWith(currentYear.toString()))
        .reduce((sum, key) => sum + salesData[key], 0);
    
    const monthPurchases = purchasesData[currentMonth] || 0;
    const monthSales = salesData[currentMonth] || 0;
    
    // Calculate averages
    const purchasesMonthsWithData = Object.keys(purchasesData).length;
    const averageMonthlyPurchases = purchasesMonthsWithData > 0 ? totalPurchases / purchasesMonthsWithData : 0;
    
    // Update purchase cards
    document.getElementById('totalPurchases').textContent = formatCurrency(totalPurchases);
    document.getElementById('yearPurchases').textContent = formatCurrency(yearPurchases);
    document.getElementById('monthPurchases').textContent = formatCurrency(monthPurchases);
    document.getElementById('averageMonthlyPurchases').textContent = formatCurrency(averageMonthlyPurchases);
    
    // Update sales cards
    document.getElementById('totalSales').textContent = formatCurrency(totalSales);
    document.getElementById('yearSales').textContent = formatCurrency(yearSales);
    document.getElementById('monthSales').textContent = formatCurrency(monthSales);
    
    // Update net flow card with color coding
    const netFlowElement = document.getElementById('netFlow');
    netFlowElement.textContent = formatCurrency(netFlow);
    netFlowElement.className = `text-2xl font-semibold ${netFlow >= 0 ? 'text-green-600' : 'text-red-600'}`;
}

function populateYearFilters() {
    const allMonths = new Set([...Object.keys(purchasesData), ...Object.keys(salesData)]);
    const years = [...new Set(Array.from(allMonths).map(key => key.split('-')[0]))].sort().reverse();
    
    // Populate main chart year filter
    const yearFilter = document.getElementById('chartYearFilter');
    yearFilter.innerHTML = '<option value="">Todos os anos</option>';
    
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
    });
}

function renderTransactionsTable() {
    const tbody = document.getElementById('transactionsTableBody');
    tbody.innerHTML = '';
    
    if (filteredTransactions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-4"></i>
                    <p>Nenhuma transação encontrada</p>
                </td>
            </tr>
        `;
        return;
    }
    
    filteredTransactions.forEach(transaction => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(transaction.transaction_date)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${transaction.ticker}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${transaction.type === 'Compra' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${transaction.type === 'Compra' ? '📈 Compra' : '📉 Venda'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatNumber(transaction.quantity)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(transaction.price)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(transaction.total_value)}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function updatePaginationInfo(response) {
    const total = response.total;
    const startIndex = (response.page - 1) * response.per_page + 1;
    const endIndex = Math.min(response.page * response.per_page, total);
    
    document.getElementById('pageInfo').textContent = `${startIndex}-${endIndex} de ${total}`;
    
    // Update button states
    const prevButton = document.querySelector('button[onclick="previousPage()"]');
    const nextButton = document.querySelector('button[onclick="nextPage()"]');
    
    prevButton.disabled = response.page <= 1;
    nextButton.disabled = response.page >= response.total_pages;
    
    if (prevButton.disabled) {
        prevButton.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        prevButton.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    if (nextButton.disabled) {
        nextButton.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

function setupFilters() {
    const chartYearFilter = document.getElementById('chartYearFilter');
    const chartTypeFilter = document.getElementById('chartTypeFilter');
    const chartTickerFilter = document.getElementById('chartTickerFilter');
    const typeFilter = document.getElementById('typeFilter');
    const tickerFilter = document.getElementById('tickerFilter');
    
    // Chart filters
    chartYearFilter.addEventListener('change', updateMainChart);
    chartTypeFilter.addEventListener('change', updateMainChart);
    chartTickerFilter.addEventListener('input', debounce(updateMainChart, 500));
    
    // Table filters
    typeFilter.addEventListener('change', () => {
        currentPage = 1;
        loadTransactionsTable().then(() => renderTransactionsTable());
    });
    
    tickerFilter.addEventListener('input', debounce(() => {
        currentPage = 1;
        loadTransactionsTable().then(() => renderTransactionsTable());
    }, 500));
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function toggleMainChartType() {
    currentMainChartType = currentMainChartType === 'bar' ? 'line' : 'bar';
    updateMainChart();
}

async function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        await loadTransactionsTable();
        renderTransactionsTable();
    }
}

async function nextPage() {
    currentPage++;
    await loadTransactionsTable();
    renderTransactionsTable();
}

function exportTransactions() {
    const csvContent = "data:text/csv;charset=utf-8," + 
        "Data,Ticker,Tipo,Quantidade,Preço,Valor Total\n" +
        filteredTransactions.map(t => 
            `${t.transaction_date},${t.ticker},${t.type},${t.quantity},${t.price},${t.total_value}`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `transacoes_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Transações exportadas com sucesso!', 'success');
}

function formatMonthYear(monthYear) {
    const [year, month] = monthYear.split('-');
    const date = new Date(year, month - 1);
    return date.toLocaleDateString('pt-BR', {
        year: 'numeric',
        month: 'short'
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

function formatNumber(value) {
    return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 6
    }).format(value);
}

// Debug function - can be called from browser console
async function debugTransactions(month = '2025-06') {
    try {
        const response = await apiRequest(`/api/transactions/debug-categories?month=${month}`);
        console.log('=== DEBUG TRANSAÇÕES ===');
        console.log(`Mês: ${response.month}`);
        console.log(`Total incluído (sem renda fixa): R$ ${formatCurrency(response.included_total)}`);
        console.log(`Total excluído (renda fixa): R$ ${formatCurrency(response.excluded_total)}`);
        console.log(`Total sem filtro: R$ ${formatCurrency(response.total_without_filter)}`);
        
        console.log('\n=== TRANSAÇÕES INCLUÍDAS ===');
        response.included_transactions.forEach(t => {
            console.log(`${t.ticker} (${t.category}) - ${t.date} - R$ ${formatCurrency(t.value)}`);
        });
        
        console.log('\n=== TRANSAÇÕES EXCLUÍDAS (RENDA FIXA) ===');
        response.excluded_transactions.forEach(t => {
            console.log(`${t.ticker} (${t.category}) - ${t.date} - R$ ${formatCurrency(t.value)}`);
        });
        
        return response;
    } catch (error) {
        console.error('Erro no debug:', error);
    }
}
</script>
{% endblock %}
